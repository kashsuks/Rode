name: Release

on:
  push:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "12.0"

jobs:
  # ── 1. Version gate ────────────────────────────────────────────────────────
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check version and release status
        id: check
        run: |
          VERSION=$(sed -n 's/^version = "\([^"]*\)"/\1/p' Cargo.toml | head -n1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          LATEST=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | grep '"tag_name":' \
            | sed -E 's/.*"v([^"]+)".*/\1/' || echo "none")

          if [ "$LATEST" != "$VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # ── 2. Linux build ─────────────────────────────────────────────────────────
  build-linux:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libxdo-dev \
            libssl-dev \
            pkg-config

      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Package
        run: |
          cp target/x86_64-unknown-linux-gnu/release/rode-editor \
             rode-editor-${VERSION}-linux-x86_64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux
          path: rode-editor-${{ env.VERSION }}-linux-x86_64
          retention-days: 1

  # ── 3. Windows build ───────────────────────────────────────────────────────
  build-windows:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Package
        shell: bash
        run: |
          cp target/x86_64-pc-windows-msvc/release/rode-editor.exe \
             rode-editor-${VERSION}-windows-x86_64.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows
          path: rode-editor-${{ env.VERSION }}-windows-x86_64.exe
          retention-days: 1

  # ── 4. macOS universal binary + DMG + tar.gz ───────────────────────────────
  build-macos:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: macos-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust with both macOS targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Locate macOS SDK
        id: sdk
        run: |
          SDK=$(xcrun --sdk macosx --show-sdk-path)
          echo "path=$SDK" >> $GITHUB_OUTPUT

      # Build Apple Silicon natively (runner is M1)
      - name: Build aarch64
        run: cargo build --release --target aarch64-apple-darwin

      # Cross-compile Intel from the ARM runner.
      # CFLAGS/CXXFLAGS tell clang to target x86_64 so C deps
      # (resvg, tiny-skia, syntect/onig) compile correctly.
      - name: Build x86_64
        env:
          SDKROOT: ${{ steps.sdk.outputs.path }}
          CFLAGS: "-target x86_64-apple-macos12.0"
          CXXFLAGS: "-target x86_64-apple-macos12.0"
        run: cargo build --release --target x86_64-apple-darwin

      - name: Create universal binary with lipo
        run: |
          mkdir -p universal
          lipo -create \
            target/aarch64-apple-darwin/release/rode-editor \
            target/x86_64-apple-darwin/release/rode-editor \
            -output universal/rode-editor
          # Confirm both architectures are present
          lipo -info universal/rode-editor

      # ── Assemble .app bundle ───────────────────────────────────────────────
      # Layout:
      #   Rode.app/
      #     Contents/
      #       Info.plist
      #       MacOS/
      #         rode-editor          ← universal binary
      #       Resources/
      #         src/                 ← assets subtree (icons.rs resolves via resources.rs)
      #         AppIcon.icns         ← if present
      - name: Assemble .app bundle
        run: |
          APP="Rode.app"
          mkdir -p "${APP}/Contents/MacOS"
          mkdir -p "${APP}/Contents/Resources/src/assets"

          # Binary
          cp universal/rode-editor "${APP}/Contents/MacOS/rode-editor"
          chmod +x "${APP}/Contents/MacOS/rode-editor"

          # Stamp version into Info.plist and place it
          sed "s/__BUNDLE_VERSION__/${VERSION}/g" \
            src/assets/macos/Info.plist > "${APP}/Contents/Info.plist"

          # Copy the entire src/assets tree so resources.rs can find icons/fonts
          # at runtime via Contents/Resources/src/assets/
          cp -r src/assets/. "${APP}/Contents/Resources/src/assets/"

          # Optional icon (add assets/macos/AppIcon.icns to your repo later)
          if [ -f "assets/macos/AppIcon.icns" ]; then
            cp assets/macos/AppIcon.icns "${APP}/Contents/Resources/AppIcon.icns"
            /usr/libexec/PlistBuddy -c \
              "Add :CFBundleIconFile string AppIcon" \
              "${APP}/Contents/Info.plist" 2>/dev/null || true
          fi

          echo "Bundle layout:"
          find "${APP}" -type f | sort

      # ── tar.gz (used by the self-updater) ─────────────────────────────────
      - name: Create tar.gz
        run: |
          tar -czf rode-editor-${VERSION}-macos-universal.tar.gz Rode.app
          echo "tar.gz: $(du -sh rode-editor-${VERSION}-macos-universal.tar.gz | cut -f1)"

      # ── DMG ───────────────────────────────────────────────────────────────
      - name: Create DMG
        run: |
          DMG="rode-editor-${VERSION}-macos-universal.dmg"

          # Build a read-write intermediate DMG
          hdiutil create \
            -volname "Rode" \
            -srcfolder "Rode.app" \
            -ov \
            -format UDRW \
            rode-rw.dmg

          # Mount it
          DEVICE=$(hdiutil attach -readwrite -noverify rode-rw.dmg \
            | grep "^/dev/" | head -n1 | awk '{print $1}')

          # Add Applications symlink so users can drag-install
          ln -sf /Applications "/Volumes/Rode/Applications"

          # Window layout via AppleScript.
          # ── To add your background image later: ──────────────────────────
          #   1. Add assets/macos/dmg-background.png to your repo
          #   2. In the build step above, copy it into the mounted volume:
          #      mkdir -p /Volumes/Rode/.background
          #      cp assets/macos/dmg-background.png /Volumes/Rode/.background/
          #   3. Uncomment the "set background picture" line below
          # ─────────────────────────────────────────────────────────────────
          osascript << 'APPLESCRIPT'
          tell application "Finder"
            tell disk "Rode"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set bounds of container window to {400, 100, 940, 480}
              set viewOptions to the icon view options of container window
              set arrangement of viewOptions to not arranged
              set icon size of viewOptions to 128
              -- set background picture of viewOptions to file ".background:dmg-background.png"
              set position of item "Rode.app" of container window to {130, 180}
              set position of item "Applications" of container window to {410, 180}
              close
              open
              update without registering applications
              delay 2
            end tell
          end tell
          APPLESCRIPT

          hdiutil detach "${DEVICE}"

          # Convert to compressed read-only DMG
          hdiutil convert rode-rw.dmg \
            -format UDZO \
            -imagekey zlib-level=9 \
            -o "${DMG}"

          rm rode-rw.dmg
          echo "DMG: $(du -sh ${DMG} | cut -f1)"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binary-macos
          path: |
            rode-editor-${{ env.VERSION }}-macos-universal.dmg
            rode-editor-${{ env.VERSION }}-macos-universal.tar.gz
          retention-days: 1

  # ── 5. Checksums — runs after all builds ──────────────────────────────────
  generate-checksums:
    needs: [check-version, build-linux, build-windows, build-macos]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          cd artifacts/
          sha256sum \
            rode-editor-${VERSION}-macos-universal.dmg \
            rode-editor-${VERSION}-macos-universal.tar.gz \
            rode-editor-${VERSION}-linux-x86_64 \
            rode-editor-${VERSION}-windows-x86_64.exe \
            > checksums.txt
          cat checksums.txt

      - name: Upload checksums artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt
          retention-days: 1

  # ── 6. Create GitHub Release ───────────────────────────────────────────────
  create-release:
    needs: [check-version, generate-checksums]
    if: needs.check-version.outputs.should_release == 'true'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: List artifacts
        run: find artifacts/ -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Rode v${{ env.VERSION }}
          body: |
            ## Rode v${{ env.VERSION }}

            ### Downloads
            | Platform | File |
            |---|---|
            | macOS Universal (Intel + Apple Silicon) | `rode-editor-${{ env.VERSION }}-macos-universal.dmg` |
            | macOS (self-updater / scripted install) | `rode-editor-${{ env.VERSION }}-macos-universal.tar.gz` |
            | Linux x86_64 | `rode-editor-${{ env.VERSION }}-linux-x86_64` |
            | Windows x86_64 | `rode-editor-${{ env.VERSION }}-windows-x86_64.exe` |

            ### Checksums
            SHA256 checksums are in `checksums.txt`.

            ### macOS note
            This build is not yet notarized. On first launch, right-click → **Open** to bypass Gatekeeper.

            Commit: ${{ github.sha }}
          files: |
            artifacts/rode-editor-${{ env.VERSION }}-macos-universal.dmg
            artifacts/rode-editor-${{ env.VERSION }}-macos-universal.tar.gz
            artifacts/rode-editor-${{ env.VERSION }}-linux-x86_64
            artifacts/rode-editor-${{ env.VERSION }}-windows-x86_64.exe
            artifacts/checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}

  # ── 7. Publish to crates.io ────────────────────────────────────────────────
  publish-crate:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # eframe/egui and other deps with system libs need these on the
      # Ubuntu runner that publishes to crates.io
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxdo-dev libssl-dev pkg-config

      - name: Publish to crates.io
        run: |
          cargo login ${{ secrets.CRATES_IO }}
          cargo publish --allow-dirty
          rm -f ~/.cargo/credentials

  # ── 8. Update AUR ─────────────────────────────────────────────────────────
  update-aur:
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - pkgname: rode-editor
            build_from_source: true
          - pkgname: rode-editor-bin
            build_from_source: false
    steps:
      - uses: actions/checkout@v4

      - name: Generate PKGBUILD (source build)
        if: matrix.build_from_source
        run: |
          cat > PKGBUILD << 'PKGEOF'
          # Maintainer: kashyap <ksukshavasi@gmail.com>
          pkgname=rode-editor
          pkgver=${{ needs.check-version.outputs.version }}
          pkgrel=1
          pkgdesc="(somewhat) fast text editor written in rust"
          arch=('x86_64')
          url="https://github.com/kashsuks/rode"
          license=('GPL3')
          depends=()
          makedepends=('rust' 'cargo' 'gtk3' 'pkg-config')
          source=("$pkgname-$pkgver.tar.gz::https://github.com/kashsuks/rode/archive/v$pkgver.tar.gz")
          sha256sums=('SKIP')

          build() {
              cd "$srcdir/rode-$pkgver"
              cargo build --release --locked
          }

          package() {
              cd "$srcdir/rode-$pkgver"
              install -Dm755 "target/release/rode-editor" "$pkgdir/usr/bin/rode-editor"
              # Install assets so the editor can find icons at runtime
              install -dm755 "$pkgdir/usr/share/rode-editor"
              cp -r src/assets "$pkgdir/usr/share/rode-editor/src/"
          }
          PKGEOF

      - name: Generate PKGBUILD (binary)
        if: ${{ !matrix.build_from_source }}
        run: |
          cat > PKGBUILD << 'PKGEOF'
          # Maintainer: kashyap <ksukshavasi@gmail.com>
          pkgname=rode-editor-bin
          pkgver=${{ needs.check-version.outputs.version }}
          pkgrel=1
          pkgdesc="(somewhat) fast text editor written in rust (binary release)"
          arch=('x86_64')
          url="https://github.com/kashsuks/rode"
          license=('GPL3')
          depends=()
          provides=('rode-editor')
          conflicts=('rode-editor')
          source=("rode-editor-$pkgver::https://github.com/kashsuks/rode/releases/download/v$pkgver/rode-editor-$pkgver-linux-x86_64")
          sha256sums=('SKIP')

          package() {
              install -Dm755 "$srcdir/rode-editor-$pkgver" "$pkgdir/usr/bin/rode-editor"
          }
          PKGEOF

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.0
        with:
          pkgname: ${{ matrix.pkgname }}
          pkgbuild: ./PKGBUILD
          commit_username: kashyap
          commit_email: ksukshavasi@gmail.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ needs.check-version.outputs.version }}